<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/resource.js | @fnndsc/chrisapi</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="JavaScript6 client for the ChRIS API"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@fnndsc/chrisapi"><meta property="twitter:description" content="JavaScript6 client for the ChRIS API"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cj.js~Collection.html">Collection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/comment.js~Comment.html">Comment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/comment.js~CommentList.html">CommentList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/exception.js~RequestException.html">RequestException</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/feed.js~Feed.html">Feed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/feed.js~FeedList.html">FeedList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/feedfile.js~FeedFile.html">FeedFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/feedfile.js~FeedFileList.html">FeedFileList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/feedfile.js~PluginInstanceFileList.html">PluginInstanceFileList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/note.js~Note.html">Note</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugin.js~Plugin.html">Plugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugin.js~PluginList.html">PluginList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugininstance.js~FeedPluginInstanceList.html">FeedPluginInstanceList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugininstance.js~PluginInstance.html">PluginInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugininstance.js~PluginInstanceDescendantList.html">PluginInstanceDescendantList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugininstance.js~PluginInstanceList.html">PluginInstanceList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugininstance.js~PluginInstanceParameter.html">PluginInstanceParameter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugininstance.js~PluginInstanceParameterList.html">PluginInstanceParameterList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginparameter.js~PluginParameter.html">PluginParameter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginparameter.js~PluginParameterList.html">PluginParameterList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resource.js~ItemResource.html">ItemResource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resource.js~ListResource.html">ListResource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resource.js~Resource.html">Resource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tag.js~FeedTagList.html">FeedTagList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tag.js~FeedTaggingList.html">FeedTaggingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tag.js~Tag.html">Tag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tag.js~TagFeedList.html">TagFeedList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tag.js~TagList.html">TagList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tag.js~TagTaggingList.html">TagTaggingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tag.js~Tagging.html">Tagging</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/uploadedfile.js~UploadedFile.html">UploadedFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/uploadedfile.js~UploadedFileList.html">UploadedFileList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/user.js~User.html">User</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/resource.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/** * Imports ***/
import Collection from &apos;./cj&apos;;
import Request from &apos;./request&apos;;
import RequestException from &apos;./exception&apos;;

/**
 * API abstract resource class.
 */
class Resource {
  /**
   * Constructor
   *
   * @param {string} resourceUrl - url of the resource
   * @param {Object} auth - authentication object
   * @param {string} auth.token - authentication token
   */
  constructor(resourceUrl, auth) {
    /** @type {string} */
    this.url = resourceUrl;

    if (!auth) {
      throw new RequestException(&apos;Authentication object is required&apos;);
    }
    /** @type {Object} */
    this.auth = auth;

    /** @type {string} */
    this.contentType = &apos;application/vnd.collection+json&apos;;

    /** @type {?Object} */
    this.collection = null; // Collection+JSON collection obj
  }

  /**
   * Make a deep copy clone of this object resource.
   *
   * @return {Object} - clone object
   */
  clone() {
    const cloneObj = Object.create(Object.getPrototypeOf(this));

    for (let prop in this) {
      if (this[prop] !== null &amp;&amp; typeof this[prop] === &apos;object&apos;) {
        cloneObj[prop] = JSON.parse(JSON.stringify(this[prop]));
      } else {
        cloneObj[prop] = this[prop];
      }
    }
    return cloneObj;
  }
}

/**
 * API abstract item resource class.
 */
export class ItemResource extends Resource {
  /**
   * Constructor
   *
   * @param {string} itemUrl - url of the resource
   * @param {Object} auth - authentication object
   * @param {string} auth.token - authentication token
   */
  constructor(itemUrl, auth) {
    super(itemUrl, auth);

    /** @type {?Object} */
    this.item = null; // Collection+JSON item obj
  }

  /**
   * Fetch this item resource from the REST API.
   *
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  get(timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);

    const result = req.get(this.url);

    return new Promise((resolve, reject) =&gt; {
      result
        .then(response =&gt; {
          // change the state of this object on successfull response
          this.collection = null;
          this.item = null;
          if (response.data &amp;&amp; response.data.collection) {
            this.collection = response.data.collection;
            this.item = this.collection.items[0];
          }
          resolve(this);
        })
        .catch(error =&gt; {
          reject(error);
        });
    });
  }

  /**
   * Get the item&apos;s data object (REST API descriptors).
   *
   * @type {?Object}
   */
  get data() {
    if (this.item) {
      return Collection.getItemDescriptors(this.item);
    }
    return null;
  }

  /**
   * Return true if the item resource object contains any item data.
   *
   * @type {boolean}
   */
  get isEmpty() {
    if (this.item) {
      return false;
    }
    return true;
  }

  /**
   * Get an array of parameter names that can be used as properties of the data
   * object in PUT requests.
   *
   * @return {?string[]} - array of PUT data property name or null if this list
   * resource&apos;s data has not been fetched from the API yet or it doesn&apos;t support
   * PUT requests.
   */
  getPUTDataParameters() {
    if (this.collection &amp;&amp; this.collection.template) {
      return Collection.getTemplateDescriptorNames(this.collection.template);
    }
    return null;
  }

  /**
   * Internal method to fetch a related resource from the REST API that is referenced
   * by a link relation within the item object.
   *
   * @param {string} linkRelation
   * @param {Object} ResourceClass
   * @param {Object} [params=null] - page parameters
   * @param {number} [params.limit] - page limit
   * @param {number} [params.offset] - page offset
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to a ``ResourceClass`` object
   * @throws {RequestException} throw error when the link relation is not found
   * @throws {RequestException} throw error if this item resource has not yet been
   * fetched from the REST API
   */
  _getResource(linkRelation, ResourceClass, params = null, timeout = 30000) {
    if (this.item) {
      const urls = Collection.getLinkRelationUrls(this.item, linkRelation);

      if (urls.length) {
        const resourceUrl = urls[0];
        const resourceObj = new ResourceClass(resourceUrl, this.auth);

        return resourceObj.get(params, timeout);
      } else {
        const errMsg = &apos;Missing &quot;&apos; + linkRelation + &apos;&quot; link relation!&apos;;
        throw new RequestException(errMsg);
      }
    }
    throw new RequestException(&apos;Item object has not been set!&apos;);
  }

  /**
   * Internal helper method to make a PUT request to this item resource through
   * the REST API.
   *
   * @param {Object} data - request JSON data object
   * @param {?Object} uploadFileObj - custom file object
   * @param {Object} uploadFileObj.fname - file blob
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  _put(data, uploadFileObj, timeout = 30000) {
    const url = this.url;
    const req = new Request(this.auth, this.contentType, timeout);
    let putData = data;

    if (!uploadFileObj &amp;&amp; this.contentType === &apos;application/vnd.collection+json&apos;) {
      putData = { template: Collection.makeTemplate(data) };
    }

    return new Promise((resolve, reject) =&gt; {
      const result = req.put(url, putData, uploadFileObj);

      result
        .then(response =&gt; {
          // change the state of this object on successfull response
          this.collection = null;
          this.item = null;
          if (response.data &amp;&amp; response.data.collection) {
            this.collection = response.data.collection;
            this.item = this.collection.items[0];
          }
          resolve(this);
        })
        .catch(error =&gt; {
          reject(error);
        });
    });
  }

  /**
   * Internal helper method to make a DELETE request to this item resource through
   * the REST API.
   *
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``null``
   */
  _delete(timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);

    return new Promise((resolve, reject) =&gt; {
      const result = req.delete(this.url);

      result
        .then(() =&gt; {
          // change the state of this object on successfull response
          this.collection = null;
          this.item = null;
          resolve(null);
        })
        .catch(error =&gt; {
          reject(error);
        });
    });
  }
}

/**
 * API abstract list resource class.
 */
export class ListResource extends Resource {
  /**
   * Constructor
   *
   * @param {string} listUrl - url of the resource
   * @param {Object} auth - authentication object
   * @param {string} auth.token - authentication token
   */
  constructor(listUrl, auth) {
    super(listUrl, auth);

    /** @type {string} */
    this.queryUrl = &apos;&apos;;

    /** @type {?Object} */
    this.searchParams = null;

    /** @type {Object} */
    this.itemClass = ItemResource;
  }

  /**
   * Fetch this list resource from the REST API using limit and offset as optional
   * parameters.
   *
   * @param {Object} [params=null] - page parameters
   * @param {number} [params.limit] - page limit
   * @param {number} [params.offset] - page offset
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  get(params = null, timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);
    let getParams = null;

    if (params) {
      for (let param in params) {
        if (params.hasOwnProperty(param) &amp;&amp; (param === &apos;limit&apos; || param === &apos;offset&apos;)) {
          if (!getParams) {
            getParams = {};
          }
          getParams[param] = params[param];
        }
      }
    }
    const result = req.get(this.url, getParams);

    return new Promise((resolve, reject) =&gt; {
      result
        .then(response =&gt; {
          // change the state of this object on successfull response
          this.collection = null;
          this.searchParams = getParams;

          if (response.data &amp;&amp; response.data.collection) {
            this.collection = response.data.collection;

            if (this.collection.queries &amp;&amp; this.collection.queries.length) {
              this.queryUrl = this.collection.queries[0].href;
            }
          }
          resolve(this);
        })
        .catch(error =&gt; {
          reject(error);
        });
    });
  }

  /**
   * Get an array of search parameter names that can be used as properties of the
   * ``params`` argument to the ``getSearch`` method.
   *
   * @return {?string[]} - array of search parameter names or null if this list
   * resource&apos;s data has not been fetched from the API yet.
   */
  getSearchParameters() {
    if (this.collection) {
      if (this.collection.queries) {
        const params = Collection.getQueryParameters(this.collection.queries);
        params.push(&apos;limit&apos;, &apos;offset&apos;);
        return params;
      }
      return [&apos;limit&apos;, &apos;offset&apos;];
    }
    return null;
  }

  /**
   * Fetch this list resource from the REST API based on search parameters.
   *
   * @param {Object} params - search parameters, the ``getSearchParameters``
   * method can be used to get a list of possible search parameters
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  getSearch(params, timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);

    if (this.queryUrl) {
      const result = req.get(this.queryUrl, params);

      return new Promise((resolve, reject) =&gt; {
        result
          .then(response =&gt; {
            // change the state of this object on successfull response
            this.collection = null;
            this.searchParams = params;
            if (response.data &amp;&amp; response.data.collection) {
              this.collection = response.data.collection;
            }
            resolve(this);
          })
          .catch(error =&gt; {
            reject(error);
          });
      });
    }
    return Promise.reject(&apos;A search url has not been setup for this resource!&apos;);
  }

  /**
   * Return true if the list resource object contains any data.
   *
   * @type {boolean}
   */
  get isEmpty() {
    if (this.collection &amp;&amp; this.collection.items.length) {
      return false;
    }
    return true;
  }

  /**
   * Return true if the list resource object has a next list page in the
   * paginated REST API.
   *
   * @type {boolean}
   */
  get hasNextPage() {
    if (this.collection) {
      const urls = Collection.getLinkRelationUrls(this.collection, &apos;next&apos;);
      if (urls.length) {
        return true;
      }
    }
    return false;
  }

  /**
   * Return true if the list resource object has a previous list page in the
   * paginated REST API.
   *
   * @type {boolean}
   */
  get hasPreviousPage() {
    if (this.collection) {
      const urls = Collection.getLinkRelationUrls(this.collection, &apos;previous&apos;);
      if (urls.length) {
        return true;
      }
    }
    return false;
  }

  /**
   * Get an array of item resource objects corresponding to the items in this
   * list resource object.
   *
   * @return {?Object[]}
   */
  getItems() {
    if (this.collection) {
      const items = this.collection.items;

      return items.map(item =&gt; {
        const itemResource = new this.itemClass(item.href, this.auth);
        itemResource.collection = this.collection;
        itemResource.item = item;

        return itemResource;
      });
    }
    return null;
  }

  /**
   * Get an array of parameter names that can be used as properties of the data
   * object in POST requests.
   *
   * @return {?string[]} - array of POST data properties or null if this list
   * resource&apos;s data has not been fetched from the API yet or it doesn&apos;t support
   * POST requests.
   */
  getPOSTDataParameters() {
    if (this.collection &amp;&amp; this.collection.template) {
      return Collection.getTemplateDescriptorNames(this.collection.template);
    }
    return null;
  }

  /**
   * Fetch the next resource page from the paginated REST API.
   *
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  getNextPage(timeout = 30000) {
    return this._getNextOrPreviousPage(&apos;next&apos;, timeout);
  }

  /**
   * Fetch the previous resource page from the paginated REST API.
   *
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  getPreviousPage(timeout = 30000) {
    return this._getNextOrPreviousPage(&apos;previous&apos;, timeout);
  }

  /**
   * Internal method to fetch the next or previous page from the paginated REST API.
   *
   * @param {string} linkRelation - either the string &apos;previous&apos; or &apos;next&apos;
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  _getNextOrPreviousPage(linkRelation, timeout = 30000) {
    if (this.collection) {
      const urls = Collection.getLinkRelationUrls(this.collection, linkRelation);

      if (urls.length) {
        const searchParams = new URL(urls[0]).searchParams;
        const params = {};
        let urlHasSearchParams = false;

        for (let pair of searchParams.entries()) {
          params[pair[0]] = pair[1];
          if (pair[0] !== &apos;offset&apos; &amp;&amp; pair[0] !== &apos;limit&apos;) {
            urlHasSearchParams = true;
          }
        }

        if (urlHasSearchParams) {
          return this.getSearch(params, timeout);
        }
        if (params.offset || params.limit) {
          return this.get(params, timeout);
        }
        return this.get(null, timeout);
      }
    }
    this.collection = null;
    this.searchParams = null;
    return Promise.resolve(this);
  }

  /**
   * Internal method to fetch a related resource from the REST API that is referenced by
   * a link relation within this list resource&apos;s collection object.
   *
   * @param {string} linkRelation
   * @param {Object} ResourceClass
   * @param {Object} [params=null] - page parameters
   * @param {number} [params.limit] - page limit
   * @param {number} [params.offset] - page offset
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to a ``ResourceClass`` object
   * @throws {RequestException} throw error when the link relation is not found
   * @throws {RequestException} throw error if this list resource has not yet been fetched from the REST API
   */
  _getResource(linkRelation, ResourceClass, params = null, timeout = 30000) {
    if (this.collection) {
      const urls = Collection.getLinkRelationUrls(this.collection, linkRelation);

      if (urls.length) {
        const resourceUrl = urls[0];
        const resourceObj = new ResourceClass(resourceUrl, this.auth);

        return resourceObj.get(params, timeout);
      } else {
        const errMsg = &apos;Missing &quot;&apos; + linkRelation + &apos;&quot; link relation!&apos;;
        throw new RequestException(errMsg);
      }
    }
    throw new RequestException(&apos;Collection object has not been set!&apos;);
  }

  /**
   * Internal helper method to make a POST request to this list resource through
   * the REST API.
   *
   * @param {Object} data - request JSON data object
   * @param {?Object} uploadFileObj - custom file object
   * @param {Object} uploadFileObj.fname - file blob
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  _post(data, uploadFileObj, timeout = 30000) {
    const url = this.url;
    const req = new Request(this.auth, this.contentType, timeout);
    let postData = data;

    if (!uploadFileObj &amp;&amp; this.contentType === &apos;application/vnd.collection+json&apos;) {
      postData = { template: Collection.makeTemplate(data) };
    }

    return new Promise((resolve, reject) =&gt; {
      const result = req.post(url, postData, uploadFileObj);

      result
        .then(response =&gt; {
          // change the state of this object on successfull response
          this.collection = null;
          this.searchParams = null;
          if (response.data &amp;&amp; response.data.collection) {
            this.collection = response.data.collection;
          }
          resolve(this);
        })
        .catch(error =&gt; {
          reject(error);
        });
    });
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
