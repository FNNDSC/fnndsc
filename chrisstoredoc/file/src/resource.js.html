<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/resource.js | @fnndsc/chrisstoreapi</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cj.js~Collection.html">Collection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/exception.js~RequestException.html">RequestException</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pipeline.js~PipelineList.html">PipelineList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pipeline.js~PipelinePipingDefaultParameterList.html">PipelinePipingDefaultParameterList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pipeline.js~PipelinePluginList.html">PipelinePluginList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pipeline.js~PipelinePluginPipingList.html">PipelinePluginPipingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pipeline.js~PipingDefaultParameter.html">PipingDefaultParameter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pipeline.js~PluginPiping.html">PluginPiping</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugin.js~Plugin.html">Plugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugin.js~PluginList.html">PluginList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugin.js~PluginMetaPluginList.html">PluginMetaPluginList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginmeta.js~PluginMeta.html">PluginMeta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginmeta.js~PluginMetaList.html">PluginMetaList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginmeta.js~UserFavoritePluginMetaList.html">UserFavoritePluginMetaList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginmeta.js~UserOwnedPluginMetaList.html">UserOwnedPluginMetaList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginparameter.js~PluginParameter.html">PluginParameter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginparameter.js~PluginParameterList.html">PluginParameterList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginstar.js~PluginStar.html">PluginStar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pluginstar.js~PluginStarList.html">PluginStarList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resource.js~ItemResource.html">ItemResource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resource.js~ListResource.html">ListResource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resource.js~Resource.html">Resource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/user.js~User.html">User</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/resource.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/** * Imports ***/
import Collection from &apos;./cj&apos;;
import Request from &apos;./request&apos;;
import RequestException from &apos;./exception&apos;;

/**
 * API abstract resource class.
 */
export class Resource {
  /**
   * Constructor
   *
   * @param {string} resourceUrl - url of the resource
   * @param {Object} [auth=null] - authentication object
   * @param {string} [auth.token] - authentication token
   */
  constructor(resourceUrl, auth = null) {
    /** @type {string} */
    this.url = resourceUrl;

    /** @type {Object} */
    this.auth = auth;

    /** @type {string} */
    this.contentType = &apos;application/vnd.collection+json&apos;;

    /** @type {?Object} */
    this.collection = null; // Collection+JSON collection obj
  }

  /**
   * Return true if the resource object contains any data.
   *
   * @type {boolean}
   */
  get isEmpty() {
    if (this.collection &amp;&amp; this.collection.items.length) {
      return false;
    }
    return true;
  }

  /**
   * Make a deep copy clone of this object resource.
   *
   * @return {Object} - clone object
   */
  clone() {
    const cloneObj = Object.create(Object.getPrototypeOf(this));

    for (let prop in this) {
      if (this[prop] !== null &amp;&amp; typeof this[prop] === &apos;object&apos;) {
        cloneObj[prop] = JSON.parse(JSON.stringify(this[prop]));
      } else {
        cloneObj[prop] = this[prop];
      }
    }
    return cloneObj;
  }
}

/**
 * API abstract item resource class.
 */
export class ItemResource extends Resource {
  /**
   * Constructor
   *
   * @param {string} itemUrl - url of the resource
   * @param {Object} [auth=null] - authentication object
   * @param {string} [auth.token] - authentication token
   */
  constructor(itemUrl, auth = null) {
    super(itemUrl, auth);
  }

  /**
   * Fetch this item resource from the REST API.
   *
   * @param {number} [timeout=30000] - request timeout
   *
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  get(timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);

    return req.get(this.url).then(resp =&gt; {
      // change the state of this object on successfull response
      this.collection = null;
      if (resp.data &amp;&amp; resp.data.collection) {
        this.collection = resp.data.collection;
      }
      return this;
    });
  }

  /**
   * Get the item&apos;s data object (REST API descriptors).
   *
   * @type {?Object}
   */
  get data() {
    if (this.isEmpty) {
      return null;
    }
    return Collection.getItemDescriptors(this.collection.items[0]);
  }

  /**
   * Get an array of parameter names that can be used as properties of the data
   * object in PUT requests.
   *
   * @return {?string[]} - array of PUT data property name or null if this list
   * resource&apos;s data has not been fetched from the API yet or it doesn&apos;t support
   * PUT requests.
   */
  getPUTParameters() {
    if (this.collection &amp;&amp; this.collection.template) {
      return Collection.getTemplateDescriptorNames(this.collection.template);
    }
    return null;
  }

  /**
   * Internal method to fetch a related resource from the REST API that is referenced
   * by a link relation within the item object.
   *
   * @param {string} linkRelation
   * @param {Object} ResourceClass
   * @param {Object} [searchParams=null] - search parameters object which is resource-specific
   * @param {number} [searchParams.limit] - page limit
   * @param {number} [searchParams.offset] - page offset
   * @param {number} [timeout=30000] - request timeout
   * @return {Object} - JS Promise, resolves to a ``ResourceClass`` object
   * @throws {RequestException} throw error if this item resource has not yet been
   * fetched from the REST API
   * @throws {RequestException} throw error when the link relation is not found
   */
  _getResource(linkRelation, ResourceClass, searchParams = null, timeout = 30000) {
    if (this.isEmpty) {
      throw new RequestException(&apos;Item object has not been set!&apos;);
    }
    const item = this.collection.items[0];
    const urls = Collection.getLinkRelationUrls(item, linkRelation);

    if (!urls.length) {
      const errMsg = &apos;Missing &quot;&apos; + linkRelation + &apos;&quot; link relation!&apos;;
      throw new RequestException(errMsg);
    }
    const resourceUrl = urls[0];
    const resourceObj = new ResourceClass(resourceUrl, this.auth);
    if (searchParams) {
      return resourceObj.get(searchParams, timeout);
    }
    return resourceObj.get(timeout);
  }

  /**
   * Internal helper method to make a PUT request to this item resource through
   * the REST API.
   *
   * @param {Object} data - request JSON data object
   * @param {?Object} uploadFileObj - custom file object
   * @param {Object} uploadFileObj.fname - file blob
   * @param {number} [timeout=30000] - request timeout
   *
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  _put(data, uploadFileObj, timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);
    let putData = data;

    if (!uploadFileObj &amp;&amp; this.contentType === &apos;application/vnd.collection+json&apos;) {
      putData = { template: Collection.makeTemplate(data) };
    }
    return req.put(this.url, putData, uploadFileObj).then(resp =&gt; {
      // change the state of this object on successfull response
      this.collection = null;
      if (resp.data &amp;&amp; resp.data.collection) {
        this.collection = resp.data.collection;
      }
      return this;
    });
  }

  /**
   * Internal helper method to make a DELETE request to this item resource through
   * the REST API.
   *
   * @param {number} [timeout=30000] - request timeout
   *
   * @return {Object} - JS Promise
   */
  _delete(timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);

    return req.delete(this.url).then(() =&gt; {
      // change the state of this object on successfull response
      this.collection = null;
    });
  }
}

/**
 * API abstract list resource class.
 */
export class ListResource extends Resource {
  /**
   * Constructor
   *
   * @param {string} listUrl - url of the resource
   * @param {Object} [auth=null] - authentication object
   * @param {string} [auth.token] - authentication token
   */
  constructor(listUrl, auth = null) {
    super(listUrl, auth);

    /** @type {string} */
    this.queryUrl = &apos;&apos;;

    /** @type {?Object} */
    this.searchParams = null;

    /** @type {Object} */
    this.itemClass = ItemResource;
  }

  /**
   * Fetch this list resource from the REST API based on search parameters. If
   * no search parameters then get the default first page.
   *
   * @param {Object} [searchParams=null] - search parameters object which is
   * resource-specific, the ``getSearchParameters`` method can be used to get a list
   * of possible search parameters
   * @param {number} [searchParams.limit] - page limit
   * @param {number} [searchParams.offset] - page offset
   * @param {number} [timeout=30000] - request timeout
   *
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  get(searchParams = null, timeout = 30000) {
    const req = new Request(this.auth, this.contentType, timeout);

    const updateInternalState = resp =&gt; {
      // change the state of this object on successfull response
      this.collection = null;
      this.searchParams = searchParams;

      if (resp.data &amp;&amp; resp.data.collection) {
        this.collection = resp.data.collection;

        if (this.collection.queries &amp;&amp; this.collection.queries.length) {
          this.queryUrl = this.collection.queries[0].href;
        }
      }
      return this;
    };

    if (searchParams) {
      for (let prop in searchParams) {
        if (searchParams.hasOwnProperty(prop) &amp;&amp; prop !== &apos;limit&apos; &amp;&amp; prop !== &apos;offset&apos;) {
          // here we assume a fixed queryUrl form but API resource objecs are more flexible than this
          this.queryUrl = this.queryUrl || this.url + &apos;search/&apos;;

          return req.get(this.queryUrl, searchParams).then(updateInternalState);
        }
      }
      return req.get(this.url, searchParams).then(updateInternalState);
    }
    return req.get(this.url).then(updateInternalState);
  }

  /**
   * Get an array of search parameter names that can be used as properties of the
   * ``searchParams`` argument to the ``get`` method.
   *
   * @return {?string[]} - array of search parameter names or null if this list
   * resource&apos;s data has not been fetched from the API yet.
   */
  getSearchParameters() {
    if (this.collection) {
      if (this.collection.queries) {
        const params = Collection.getQueryParameters(this.collection.queries);
        params.push(&apos;limit&apos;, &apos;offset&apos;);
        return params;
      }
      return [&apos;limit&apos;, &apos;offset&apos;];
    }
    return null;
  }

  /**
   * Get an item resource object given its id from the list of items in this
   * list resource object.
   *
   * @param {number} id - item id
   *
   * @return {Object} - an instance of ``this.itemClass``
   */
  getItem(id) {
    if (this.isEmpty) {
      return null;
    }
    const items = this.collection.items.filter(
      item =&gt; Collection.getItemDescriptors(item).id === id
    );
    if (!items.length) {
      return null;
    }
    const itemResource = new this.itemClass(items[0].href, this.auth);
    const listRes = this.clone();
    listRes.collection.items[0] = items[0];
    itemResource.collection = listRes.collection;
    return itemResource;
  }

  /**
   * Get an array of item resource objects corresponding to the items in this
   * list resource object.
   *
   * @return {?Object[]}
   */
  getItems() {
    if (this.isEmpty) {
      return [];
    }
    return this.collection.items.map(item =&gt; {
      const itemResource = new this.itemClass(item.href, this.auth);
      const listRes = this.clone();
      listRes.collection.items[0] = item;
      itemResource.collection = listRes.collection;
      return itemResource;
    });
  }

  /**
   * Get the list of item data objects (REST API descriptors).
   *
   * @type {Object[]}
   */
  get data() {
    const data = [];

    if (!this.isEmpty) {
      // for each item get its data
      for (let item of this.collection.items) {
        data.push(Collection.getItemDescriptors(item));
      }
    }
    return data;
  }

  /**
   * Get the total count of items of the entire collection across pages in the
   * paginated REST API. Return -1 if no data has been fetched or the total
   * number of items info is not available from the fetched data.
   *
   * @type {number}
   */
  get totalCount() {
    if (this.collection) {
      return Collection.getTotalNumberOfItems(this.collection);
    }
    return -1;
  }

  /**
   * Return true if the list resource object has a next list page in the
   * paginated REST API.
   *
   * @type {boolean}
   */
  get hasNextPage() {
    if (this.collection) {
      const urls = Collection.getLinkRelationUrls(this.collection, &apos;next&apos;);
      if (urls.length) {
        return true;
      }
    }
    return false;
  }

  /**
   * Return true if the list resource object has a previous list page in the
   * paginated REST API.
   *
   * @type {boolean}
   */
  get hasPreviousPage() {
    if (this.collection) {
      const urls = Collection.getLinkRelationUrls(this.collection, &apos;previous&apos;);
      if (urls.length) {
        return true;
      }
    }
    return false;
  }

  /**
   * Get an array of parameter names that can be used as properties of the data
   * object in POST requests.
   *
   * @return {?string[]} - array of POST data properties or null if this list
   * resource&apos;s data has not been fetched from the API yet or it doesn&apos;t support
   * POST requests.
   */
  getPOSTParameters() {
    if (this.collection &amp;&amp; this.collection.template) {
      return Collection.getTemplateDescriptorNames(this.collection.template);
    }
    return null;
  }

  /**
   * Internal method to fetch a related resource from the REST API that is
   * referenced by a link relation within this list resource&apos;s collection object.
   *
   * @param {string} linkRelation
   * @param {Object} ResourceClass
   * @param {Object} [searchParams=null] - search parameters object which is resource-specific
   * @param {number} [searchParams.limit] - page limit
   * @param {number} [searchParams.offset] - page offset
   * @param {number} [timeout=30000] - request timeout
   *
   * @return {Object} - JS Promise, resolves to a ``ResourceClass`` object
   * @throws {RequestException} throw error if this list resource has not yet
   * been fetched from the REST API
   * @throws {RequestException} throw error when the link relation is not found
   */
  _getResource(linkRelation, ResourceClass, searchParams = null, timeout = 30000) {
    if (!this.collection) {
      throw new RequestException(&apos;Collection object has not been set!&apos;);
    }
    const urls = Collection.getLinkRelationUrls(this.collection, linkRelation);

    if (!urls.length) {
      const errMsg = &apos;Missing &quot;&apos; + linkRelation + &apos;&quot; link relation!&apos;;
      throw new RequestException(errMsg);
    }
    const resourceUrl = urls[0];
    const resourceObj = new ResourceClass(resourceUrl, this.auth);

    if (searchParams) {
      return resourceObj.get(searchParams, timeout);
    }
    return resourceObj.get(timeout);
  }

  /**
   * Internal helper method to make a POST request to this list resource through
   * the REST API.
   *
   * @param {Object} data - request JSON data object
   * @param {?Object} uploadFileObj - custom file object
   * @param {Object} uploadFileObj.fname - file blob
   * @param {number} [timeout=30000] - request timeout
   *
   * @return {Object} - JS Promise, resolves to ``this`` object
   */
  _post(data, uploadFileObj, timeout = 30000) {
    const url = this.url;
    const req = new Request(this.auth, this.contentType, timeout);
    let postData = data;

    if (!uploadFileObj &amp;&amp; this.contentType === &apos;application/vnd.collection+json&apos;) {
      postData = { template: Collection.makeTemplate(data) };
    }

    return req.post(url, postData, uploadFileObj).then(resp =&gt; {
      // change the state of this object on successfull response
      this.collection = null;
      this.searchParams = null;
      if (resp.data &amp;&amp; resp.data.collection) {
        this.collection = resp.data.collection;
      }
      return this;
    });
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
